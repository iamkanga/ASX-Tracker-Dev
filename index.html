<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Watchlist (Updated)</title>
    <link rel="icon" href="favicon.png" type="image/png">

    <link rel="stylesheet" href="style.css?v=0.1.5">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="./manifest.json">
    <style>
        /* Modal dropdowns and inputs: consistent alignment and centering */
        .modal-content .dropdown-large,
        .modal-content input[type="number"],
        .modal-content input[type="text"] {
            display: block;
            width: 95%;
            min-width: 0;
            max-width: 100%;
            box-sizing: border-box;
            margin-bottom: 18px;
            margin-top: 4px;
            margin-left: auto;
            margin-right: auto;
        }
        /* --- Controls row: all controls on one line, maximize mobile area --- */
        .controls-flex-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            flex-wrap: nowrap;
        }
        .watchlist-group, .sort-group, .toggle-asx-buttons-group {
            display: flex;
            align-items: center;
            min-width: 0;
            flex-shrink: 1;
        }
        .dropdown-large {
            font-size: 1.1rem;
            padding: 7px 8px;
            margin-bottom: 0;
            box-sizing: border-box;
            width: auto;
            min-width: 70px;
            max-width: 100vw;
            flex-shrink: 1;
        }
        .toggle-asx-buttons-group {
            flex-shrink: 1;
        }
        .header-action-btn {
            padding: 7px 10px;
            font-size: 1.1rem;
        }
        @media (max-width: 500px) {
            .controls-flex-row {
                gap: 4px;
            }
            .dropdown-large {
                padding: 5px 4px;
                font-size: 0.98rem;
                min-width: 48px;
            }
            .header-action-btn {
                padding: 5px 6px;
                font-size: 1rem;
            }
        }
        /* Basic spinner animation for loading overlay */
        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style for the Google Sign-In button */
        .google-auth-btn {
            background-color: #847c74; /* Custom background color. */
            color: white; /* Text color. Change to 'black' or another color if you use a light background. */
            border: 2px solid black; /* Black border as requested. */
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Slightly stronger shadow for contrast */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px; /* Adds space between the icon and the text */
        }

        .google-auth-btn:hover {
            background-color: #756f68; /* A slightly darker shade for hover effect. */
            box-shadow: 0 4px 8px rgba(0,0,0,0.25);
        }

        .splash-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            min-height: 100vh;
            padding-bottom: 10vh;
        }
        @media (min-width: 769px) {
            .splash-screen {
                justify-content: center;
                padding-bottom: 0;
            }
        }
    </style>
        <style>
        /* Dynamic Watchlist Title + Sort Row */
    .watchlist-title-bar-row, .sort-line-row { display:flex; align-items:center; justify-content:center; width:100%; }
    .watchlist-dynamic-title { margin:4px 0 2px; font-size:1.85rem; font-weight:650; cursor:pointer; text-align:center; line-height:1.1; flex:0 1 auto; width:auto; outline:none; }
    #dynamicWatchlistTitleText { cursor:pointer; display:inline-block; padding:0 4px; border-radius:4px; pointer-events:auto; }
    #dynamicWatchlistTitle { user-select:none; pointer-events:auto; }
    /* Keyboard-only focus ring should be green; suppress mouse focus ring */
    #dynamicWatchlistTitleText:focus { outline:none; }
    #dynamicWatchlistTitleText:focus-visible { outline:2px solid var(--green-color); outline-offset:2px; }
        .watchlist-dynamic-title:focus { outline:none; }
    .sort-line-row { gap:12px; font-size:0.9rem; margin-bottom:6px; }
        .current-sort-display { min-height:1.2em; font-weight:500; }
    /* Subtle triangle toggle: two chevrons forming minimal arrow */
    /* Reworked subtle chevron toggle (single arrow) */
    .asx-toggle-triangle { position:relative; width:30px; height:26px; background:transparent; border:none !important; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; -webkit-tap-highlight-color: transparent; }
    .asx-toggle-triangle::before { content:""; width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; border-top:10px solid var(--text-color); transition:transform .28s ease; transform-origin:center; }
    .asx-toggle-triangle.expanded::before { transform:rotate(180deg); }
    .asx-toggle-triangle::after { display:none; }
    /* Remove mouse/touch focus ring but keep keyboard focus-visible */
    .asx-toggle-triangle:focus { outline:none; }
    .asx-toggle-triangle:focus-visible { outline:2px solid var(--accent-color,#a49393); outline-offset:2px; border-radius:4px; }
    .asx-toggle-triangle:active { outline:none; }
    @media (hover:hover){ .asx-toggle-triangle:hover::before, .asx-toggle-triangle:hover::after { opacity:1; } }
        /* Watchlist picker modal */
        .watchlist-picker-list { display:flex; flex-direction:column; gap:6px; margin:12px 0; }
    .watchlist-picker-list .picker-item { padding:10px 12px; border:1px solid var(--border-color,#d0d0d0); border-radius:6px; cursor:pointer; background:var(--card-bg,#fff); color:var(--text-color); font-size:0.95rem; display:flex; justify-content:space-between; align-items:center; transition:background .18s,color .18s,border-color .18s; }
    .watchlist-picker-list .picker-item.active { background:var(--accent-color,#a49393); color:#fff; border-color:var(--accent-color,#a49393); font-weight:600; box-shadow:0 0 0 2px rgba(255,255,255,0.18) inset; }
    .watchlist-picker-list .picker-item:hover { background:var(--hover-bg,#f5f7fa); }
    /* Dark theme override (assumes a body.dark or body.dark-theme class if present) */
    body.dark .watchlist-picker-list .picker-item { background:var(--card-bg,#222); border-color:var(--border-color,#444); }
    body.dark .watchlist-picker-list .picker-item:hover { background:#2e2e2e; }
    body.dark .watchlist-picker-list .picker-item.active { background:var(--accent-color,#a49393); color:#fff; border-color:var(--accent-color,#a49393); box-shadow:0 0 0 2px rgba(0,0,0,0.4) inset; }
        .modal-content.watchlist-picker { max-width:400px; width:94%; }
        .modal-actions { text-align:right; margin-top:8px; }
        @media (max-width:600px){
            .watchlist-dynamic-title { font-size:1.25rem; }
            .sort-line-row { gap:10px; }
            .code-buttons-toggle { font-size:0.8rem; }
        }
    /* Flash highlight for scrolled share */
    .flash-highlight { animation: flashFade 1.2s ease-in-out; }
    @keyframes flashFade { 0% { box-shadow:0 0 0 3px var(--accent-color,#a49393); } 50% { box-shadow:0 0 0 1px var(--accent-color,#a49393); } 100% { box-shadow:none; } }
        </style>
</head>
<body>
    <div id="splashScreen" class="splash-screen">
        <img id="splashKangarooIcon" src="Kangaicon.jpg" alt="Kangaroo App Icon" class="splash-icon">
        <button id="splashSignInBtn" class="google-auth-btn">
            <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;">
                <g fill="none" fill-rule="evenodd">
                  <path d="M17.64 9.2045c0-.6381-.0573-1.2518-.1682-1.8409H9v3.4818h4.8441c-.2086 1.125-.8441 2.0782-1.7777 2.7218v2.2591h2.9082c1.7018-1.5668 2.6841-3.8736 2.6841-6.6218z" fill="#4285F4"></path>
                  <path d="M9 18c2.43 0 4.47-.8064 5.96-2.1818l-2.9082-2.2591c-.8064.5409-1.8409.8618-3.0518.8618-2.3455 0-4.3291-1.5818-5.0359-3.7164H.9545v2.3318C2.4545 16.1373 5.4818 18 9 18z" fill="#34A853"></path>
                  <path d="M3.9641 10.71c-.1818-.5409-.2864-1.1164-.2864-1.71s.1045-1.1691.2864-1.71V4.9582H.9545C.3477 6.1718 0 7.5477 0 9s.3477 2.8282.9545 4.0418L3.9641 10.71z" fill="#FBBC05"></path>
                  <path d="M9 3.5782c1.3227 0 2.5091.4555 3.44 1.3455l2.5818-2.5818C13.4636.8918 11.4273 0 9 0 5.4818 0 2.4545 1.8627.9545 4.9582L3.9641 7.29C4.6709 5.1545 6.6545 3.5782 9 3.5782z" fill="#EA4335"></path>
                </g>
            </svg>
            <span>Sign in with Google</span>
        </button>
    </div>

    <header id="appHeader" class="app-hidden">
    <div class="header-top-row single-dynamic-title" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <button id="hamburgerBtn" class="hamburger-btn header-action-btn-left" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>
            <!-- Single dynamic clickable title acts as the only title bar -->
            <h1 id="dynamicWatchlistTitle" class="watchlist-dynamic-title" aria-haspopup="dialog" aria-expanded="false"><span id="dynamicWatchlistTitleText" tabindex="0">Share Watchlist</span></h1>
            <button id="addShareHeaderBtn" class="header-action-btn header-action-btn-right icon-button" aria-label="Add Share">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <!-- Sort row with subtle arrow toggle -->
        <div id="sortLine" class="sort-line-row">
            <select id="sortSelect" class="dropdown-large" aria-label="Sort"></select>
            <button id="toggleAsxButtonsBtn" class="asx-toggle-triangle" aria-label="Toggle code buttons" aria-pressed="false" aria-controls="asxCodeButtonsContainer"></button>
        </div>
        <select id="watchlistSelect" style="display:none"></select>
    <!-- Market status banner (shown automatically when market is closed) -->
    <div id="marketStatusBanner" class="market-status-banner app-hidden" aria-live="polite"></div>
        
        <div id="asxCodeButtonsContainer" class="asx-code-buttons-container">
            </div>
    </header>
        <!-- Watchlist selection modal -->
        <div id="watchlistPickerModal" class="modal app-hidden" role="dialog" aria-modal="true" aria-labelledby="watchlistPickerTitle">
            <div class="modal-content watchlist-picker">
                <h3 id="watchlistPickerTitle">Select Watchlist</h3>
                <div id="watchlistPickerList" class="watchlist-picker-list"></div>
                <div class="modal-actions">
                        <button id="closeWatchlistPickerBtn" class="header-action-btn">Close</button>
                </div>
            </div>
        </div>

    <nav id="appSidebar" class="app-sidebar">
        <button id="closeMenuBtn" class="close-menu-btn">X</button>
        
        <div class="menu-section">
            <h3>Share Actions</h3>
            <div class="menu-buttons-group">
                <button id="toggleCompactViewBtn" class="menu-button-item" data-action-closes-menu="true">
                    <i class="fas fa-th-large"></i> <span>Toggle Compact View</span>
                </button>
                <button id="refreshLivePricesBtn" class="menu-button-item" data-action-closes-menu="false">
                    <i class="fas fa-sync-alt"></i> <span>Refresh Live Prices</span>
                </button>
                <button id="newShareBtn" class="menu-button-item" data-action-closes-menu="true">
                    <i class="fas fa-plus-circle"></i> <span>Add New Share</span>
                </button>
                <button id="searchStockBtn" class="menu-button-item" data-action-closes-menu="true">
                    <i class="fas fa-search-plus"></i> <span>Search & Add Stock</span>
                </button>
            </div>
        </div>

        <div class="menu-section">
            <h3>Watchlists</h3>
            <div class="menu-buttons-group">
                <button id="addWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                    <i class="fas fa-list-ul"></i> <span>Add Watchlist</span>
                </button>
                <button id="editWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                    <i class="fas fa-edit"></i> <span>Edit Current Watchlist</span>
                </button>
            </div>
        </div>

        <div class="menu-section">
            <h3>Calculators</h3>
            <div class="menu-buttons-group">
                <button id="standardCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                    <i class="fas fa-calculator"></i> <span>Standard</span>
                </button>
                <button id="dividendCalcBtn" class="menu-button-item" data-action-closes-menu="true">
                    <i class="fas fa-money-bill-wave"></i> <span>Dividend</span>
                </button>
            </div>
        </div>

        <div class="menu-section">
            <h3>Theme</h3>
            <div class="menu-buttons-group">
                <label for="colorThemeSelect" class="theme-select-label">Choose Color Theme:</label>
                <select id="colorThemeSelect" class="dropdown-large menu-dropdown" data-action-closes-menu="false">
                    <option value="none" selected>No Custom Theme</option>
                    <optgroup label="Bold Themes">
                        <option value="bold-1">Bold Ocean</option>
                        <option value="bold-2">Bold Forest</option>
                        <option value="bold-3">Bold Sunset</option>
                        <option value="bold-4">Bold Royal</option>
                        <option value="bold-5">Bold Grape</option>
                        <option value="bold-6">Bold Fire</option>
                        <option value="bold-7">Bold Emerald</option>
                        <option value="bold-8">Bold Plum</option>
                        <option value="bold-9">Bold Aqua</option>
                        <option value="bold-10">Bold Ruby</option>
                    </optgroup>
                    <optgroup label="Subtle Themes">
                        <option value="subtle-1">Subtle Sky</option>
                        <option value="subtle-2">Subtle Earth</option>
                        <option value="subtle-3">Subtle Rose</option>
                        <option value="subtle-4">Subtle Lavender</option>
                        <option value="subtle-5">Subtle Mint</option>
                        <option value="subtle-6">Subtle Sand</option>
                        <option value="subtle-7">Subtle Graphite</option>
                        <option value="subtle-8">Subtle Peach</option>
                        <option value="subtle-9">Subtle Teal</option>
                        <option value="subtle-10">Subtle Stone</option>
                    </optgroup>
                    <optgroup label="Muted Themes">
                        <option value="Muted Blue">Muted Blue</option>
                        <option value="Muted Brown">Muted Brown</option>
                        <option value="Muted Pink">Muted Pink</option>
                        <option value="Muted Green">Muted Green</option>
                        <option value="Muted Purple">Muted Purple</option>
                        <option value="Muted Orange">Muted Orange</option>
                        <option value="Muted Cyan">Muted Cyan</option>
                        <option value="Muted Magenta">Muted Magenta</option>
                        <option value="Muted Gold">Muted Gold</option>
                        <option value="Muted Grey">Muted Grey</option>
                    </optgroup>
                </select>

                <button id="themeToggleBtn" class="menu-button-item" data-action-closes-menu="false">
                    <i class="fas fa-palette"></i> <span>Theme Toggle</span>
                </button>
                
                <button id="revertToDefaultThemeBtn" class="menu-button-item secondary-buttons" data-action-closes-menu="false">
                    <i class="fas fa-sun"></i><i class="fas fa-moon"></i> <span>Default Theme</span>
                </button>
            </div>
        </div>
        
        <div class="menu-section">
            <h3>Data Actions</h3>
            <div class="menu-buttons-group">
                <button id="exportWatchlistBtn" class="menu-button-item" data-action-closes-menu="true">
                    <i class="fas fa-file-export"></i> <span>Export Watchlist (CSV)</span>
                </button>
            </div>
        </div>

        <div class="menu-section data-management-section">
            <h3>Data Management</h3>
            <div class="menu-buttons-group">
                <button id="deleteAllUserDataBtn" class="menu-button-item danger-button" data-action-closes-menu="true">
                    <i class="fas fa-exclamation-triangle"></i> <span>Delete All My Data</span>
                </button>
            </div>
        </div>

        <div class="menu-section logout-section">
            <h3>Account</h3>
            <div class="menu-buttons-group">
                <span id="logoutBtn" class="menu-button-item danger-button" data-action-closes-menu="true">
                    <i class="fas fa-sign-out-alt"></i> <span>Log Out</span>
                </span>
            </div>
        </div>
    </nav>

    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <main class="container app-hidden">
        <div id="firebaseInitError" class="error-message" style="display: none;">
            <p><strong>Error:</strong> Firebase failed to initialize.</p>
            <p>This is usually due to missing or incorrect Firebase configuration. Please ensure your <code>firebaseConfig</code> in <code>index.html</code> is correctly set up from your Firebase project settings.</p>
            <p>Core application features will not work without a valid Firebase connection.</p>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="loader"></div>
            <p>Loading data...</p>
        </div>

        <div id="stockWatchlistSection" class="share-list-section">
            <div class="table-container">
                <table id="shareTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Live Price</th>
                            <th>Target Price</th>
                            <th>Reference Price</th>
                            <th>Rating</th>
                            <th>Dividends</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <div id="mobileShareCards" class="mobile-share-cards">
                </div>
        </div>

        <div id="cashAssetsSection" class="cash-assets-section app-hidden">
            <h2>Cash & Assets Balances</h2>
            <div id="cashCategoriesContainer" class="cash-categories-container">
                <p class="empty-message">No cash categories added yet. Click "Add Category" to get started!</p>
            </div>
            <div class="cash-actions">
                </div>
            <div class="total-cash-display">
                <h3>Total Cash: <span id="totalCashDisplay">$0.00</span></h3>
            </div>
        </div>
    </main>

    <button id="targetHitIconBtn" class="icon-button target-hit-fixed-btn app-hidden" title="View Target Price Alerts">
        <img src="notification_icon.png" alt="Notifications">
        <span id="targetHitIconCount" class="badge">0</span>
    </button>

    <button id="scrollToTopBtn" title="Go to top"><i class="fas fa-arrow-up"></i></button>

    <div id="shareFormSection" class="modal">
        <div class="modal-content add-share-modal-content">
            <div class="modal-header-with-icon">
                <div class="modal-title-container">
                    <h2 id="formTitle">Add New Share</h2>
                    <p id="formCompanyName" class="modal-company-name-display"></p>
                </div>
                <div class="modal-header-action-group">
                    <span id="deleteShareBtn" class="modal-action-icon danger hidden" title="Delete"><i class="fas fa-trash-alt"></i></span>
                    <span id="saveShareBtn" class="modal-action-icon" title="Save Share"><i class="fas fa-save"></i></span>
                    <span class="close-button form-close-button">&times;</span>
                </div>
            </div>
            
            <div class="modal-body-scrollable">
                <!-- Watchlist and Code Selection (always at top) -->
                <label for="shareWatchlistSelect">Assign to Watchlist:</label>
                <select id="shareWatchlistSelect" class="dropdown-large" required>
                    <option value="" disabled selected>Select a Watchlist</option>
                </select>

                <label for="shareName">Code:</label>
                <div class="search-input-container">
                    <input type="text" id="shareName" placeholder="e.g., BHP" autocomplete="off" required>
                    <div id="shareNameSuggestions" class="autocomplete-suggestions"></div>
                </div>

                <!-- Portfolio/Share Details Section (all grouped for clarity and extensibility) -->
                <div class="portfolio-details-section" style="margin-top: 24px; padding: 16px; border: 1px solid var(--ghosted-text,#ccc); border-radius: 8px; background: var(--modal-bg,#f9f9f9);">
                    <!-- Portfolio-specific fields (required for portfolio tracking) -->
                    <div class="portfolio-inputs-group" style="margin-bottom: 18px;">
                        <label for="portfolioShares">Number of Shares Purchased:</label>
                        <input type="number" id="portfolioShares" min="0" step="1" placeholder="e.g., 1000">

                        <label for="portfolioAvgPrice">Average Purchase Price ($):</label>
                        <input type="number" id="portfolioAvgPrice" min="0" step="0.01" placeholder="e.g., 23.45">
                    </div>

                    <!-- Share-specific fields (apply to both portfolio and watchlist entries) -->
                    <label for="shareRating">Star Rating:</label>
                    <select id="shareRating" class="dropdown-large">
                        <option value="0" selected>No Rating</option>
                        <option value="1">⭐ 1 Star</option>
                        <option value="2">⭐⭐ 2 Stars</option>
                        <option value="3">⭐⭐⭐ 3 Stars</option>
                        <option value="4">⭐⭐⭐⭐ 4 Stars</option>
                        <option value="5">⭐⭐⭐⭐⭐ 5 Stars</option>
                    </select>

                    <!-- Live Price Display (optional, shown if available) -->
                    <div id="addShareLivePriceDisplay" class="live-price-display-section" style="display: none;"></div>

                    <!-- Target Price and Direction -->
                    <div class="form-group-with-toggle">
                        <label for="targetPrice" class="target-price-label">Target Price ($):</label>
                        <div class="target-checkbox-grid">
                            <div class="target-checkbox-row">
                                <label class="checkbox-label" for="targetBuyCheckbox">
                                    <input type="checkbox" id="targetBuyCheckbox" class="modern-checkbox" disabled>
                                    Buy
                                </label>
                                <label class="checkbox-label" for="targetAboveCheckbox">
                                    <input type="checkbox" id="targetAboveCheckbox" class="modern-checkbox">
                                    Above
                                </label>
                            </div>
                            <div class="target-checkbox-row">
                                <label class="checkbox-label" for="targetSellCheckbox">
                                    <input type="checkbox" id="targetSellCheckbox" class="modern-checkbox" disabled>
                                    Sell
                                </label>
                                <label class="checkbox-label" for="targetBelowCheckbox">
                                    <input type="checkbox" id="targetBelowCheckbox" class="modern-checkbox" checked>
                                    Below
                                </label>
                            </div>
                        </div>
                        <input type="number" id="targetPrice" step="0.01" placeholder="e.g., 25.50">
                    </div>

                    <!-- Price and Dividend Details -->
                    <label for="currentPrice">Reference Price ($):</label>
                    <input type="number" id="currentPrice" step="0.01" placeholder="e.g., 25.50">

                    <label for="dividendAmount">Dividend Amount (per share, annual $):</label>
                    <input type="number" id="dividendAmount" step="0.001" placeholder="e.g., 1.250">

                    <label for="frankingCredits">Franking Credits (%):</label>
                    <input type="number" id="frankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70 for 70%">

                    <!-- Comments Section (optional, can add multiple) -->
                    <div class="comments-form-container">
                        <h3>Comments <span id="addCommentSectionBtn" class="add-section-icon"><i class="fas fa-plus"></i></span></h3>
                        <div id="dynamicCommentsArea">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="shareDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <div class="modal-title-container">
                    <h2 id="modalShareName">Share Details</h2>
                    <p id="modalCompanyName" class="modal-company-name-display"></p>
                </div>
                <div class="modal-header-action-group">
                    <span id="deleteShareFromDetailBtn" class="modal-action-icon danger" title="Delete Share"><i class="fas fa-trash-alt"></i></span>
                    <span id="editShareFromDetailBtn" class="modal-action-icon" title="Edit Share"><i class="fas fa-edit"></i></span>
                    <span class="close-button">&times;</span>
                </div>
            </div>
            
            <div class="modal-body-scrollable">
                <div id="modalLivePriceDisplaySection" class="live-price-display-section">
                    </div>

                <p><strong>Reference Price:</strong> <span id="modalEnteredPrice"></span></p>
                <p><strong>Target Price:</strong> <span id="modalTargetPrice"></span></p>
                <p><strong>Dividend Amount:</strong> <span id="modalDividendAmount"></span></p>
                <p><strong>Franking Credits:</strong> <span id="modalFrankingCredits"></span></p>
                <p><strong>Unfranked Yield:</strong> <span id="modalUnfrankedYield"></span></p>
                <p><strong>Franked Yield:</strong> <span id="modalFrankedYield"></span></p>
                <p><strong>Entry Date:</strong> <span id="modalEntryDate"></span></p>
                <p><strong>Star Rating:</strong> <span id="modalStarRating"></span></p>

                <div id="modalCommentsContainer" class="modal-comments-sections">
                    <h3>Comments</h3>
                    </div>

                <div class="external-links-section">
                    <h3>External Links</h3>
                    <div class="external-link-item">
                        <a id="modalNewsLink" href="#" target="_blank" class="external-link">View News <i class="fas fa-external-link-alt"></i></a>
                    </div>
                    <div class="external-link-item">
                        <a id="modalMarketIndexLink" href="#" target="_blank" class="external-link">View on MarketIndex.com.au <i class="fas fa-external-link-alt"></i></a>
                    </div>
                    <div class="external-link-item">
                        <a id="modalFoolLink" href="#" target="_blank" class="external-link">View on Fool.com.au <i class="fas fa-external-link-alt"></i></a>
                    </div>
                    <div class="external-link-item">
                    <a id="modalListcorpLink" href="#" target="_blank" class="external-link">View on Listcorp.com <i class="fas fa-external-link-alt"></i></a>
                </div>
                    <div class="external-link-item">
                        <a id="modalCommSecLink" href="#" target="_blank" class="external-link">View on commsec.com.au <i class="fas fa-external-link-alt"></i></a>
                        <p id="commSecLoginMessage" class="ghosted-text commsec-message">Requires CommSec login per session</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addWatchlistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <h2>Add New Watchlist</h2>
                <div class="modal-header-action-group">
                    <span id="saveWatchlistBtn" class="modal-action-icon" title="Save Watchlist"><i class="fas fa-save"></i></span>
                    <span class="close-button">&times;</span>
                </div>
            </div>
            <label for="newWatchlistName">Watchlist Name:</label>
            <input type="text" id="newWatchlistName" placeholder="e.g., Tech Stocks" required>
        </div>
    </div>

    <div id="manageWatchlistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <h2>Manage Watchlist</h2>
                <div class="modal-header-action-group">
                    <span id="deleteWatchlistInModalBtn" class="modal-action-icon danger" title="Delete Watchlist"><i class="fas fa-trash-alt"></i></span>
                    <span id="saveWatchlistNameBtn" class="modal-action-icon" title="Save Name"><i class="fas fa-save"></i></span>
                    <span class="close-button">&times;</span>
                </div>
            </div>
            <label for="editWatchlistName">Watchlist Name:</label>
            <input type="text" id="editWatchlistName" required>
        </div>
    </div>

    <div id="dividendCalculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button calc-close-button">&times;</span>
            <h2>Dividend Calculator</h2>
            <div class="calc-input-group">
                <label for="calcCurrentPrice">Share Price ($):</label>
                <input type="number" id="calcCurrentPrice" step="0.01" placeholder="e.g., 25.50">
            </div>
            <div class="calc-input-group">
                <label for="calcDividendAmount">Dividend Amount (per share, annual $):</label>
                <input type="number" id="calcDividendAmount" step="0.001" placeholder="e.g., 1.250">
            </div>
            <div class="calc-input-group">
                <label for="calcFrankingCredits">Franking Credits (%):</label>
                <input type="number" id="calcFrankingCredits" step="0.1" min="0" max="100" placeholder="e.g., 70 for 70%">
            </div>
            <p><strong>Unfranked Yield:</strong> <span id="calcUnfrankedYield"></span></p>
            <p><strong>Franked Yield:</strong> <span id="calcFrankedYield"></span></p>
            <hr>
            <div class="calc-input-group">
                <label for="investmentValueSelect">Investment Value:</label>
                <select id="investmentValueSelect">
                    <option value="1000">$1,000</option>
                    <option value="5000">$5,000</option>
                    <option value="10000" selected>$10,000</option>
                    <option value="25000">$25,000</option>
                    <option value="50000">$50,000</option>
                    <option value="100000">$100,000</option>
                </select>
            </div>
            <p><strong>Estimated Annual Dividend:</strong> <span id="calcEstimatedDividend"></span></p>
        </div>
    </div>

    <div id="calculatorModal" class="modal">
        <div class="modal-content calculator-modal-content">
            <span class="close-button">&times;</span>
            <h2>Standard Calculator</h2>
            <div class="calculator-display">
                <div id="calculatorInput" class="calculator-input"></div>
                <div id="calculatorResult" class="calculator-result">0</div>
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="percentage">%</button>
                <button class="calc-btn operator" data-action="divide">÷</button>
                
                <button class="calc-btn" data-value="7">7</button>
                <button class="calc-btn" data-value="8">8</button>
                <button class="calc-btn" data-value="9">9</button>
                <button class="calc-btn operator" data-action="multiply">×</button>
                
                <button class="calc-btn" data-value="4">4</button>
                <button class="calc-btn" data-value="5">5</button>
                <button class="calc-btn" data-value="6">6</button>
                <button class="calc-btn operator" data-action="subtract">-</button>
                
                <button class="calc-btn" data-value="1">1</button>
                <button class="calc-btn" data-value="2">2</button>
                <button class="calc-btn" data-value="3">3</button>
                <button class="calc-btn operator" data-action="add">+</button>
                
                <button class="calc-btn zero" data-value="0">0</button>
                <button class="calc-btn" data-value=".">.</button>
                <button class="calc-btn equals" data-action="calculate">=</button>
            </div>
        </div>
    </div>

    <div id="customDialogModal" class="modal">
        <div class="modal-content">
            <p id="customDialogMessage"></p>
            <div class="custom-dialog-buttons">
                <span id="customDialogConfirmBtn" class="modal-action-icon" title="Yes"><i class="fas fa-check-circle"></i></span>
                <span id="customDialogCancelBtn" class="modal-action-icon danger" title="No"><i class="fas fa-times-circle"></i></span>
            </div>
        </div>
    </div>

    <div id="targetHitDetailsModal" class="modal target-hit-details-modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <h2 id="targetHitModalTitle">Target Price Alerts</h2>
                </div>
            
            <div class="modal-body-scrollable">
                <div id="targetHitSharesList" class="target-hit-shares-list">
                    <p class="no-alerts-message">No shares currently at target price.</p>
                </div>
            </div>
            <div class="modal-action-buttons-footer">
                <button id="alertModalMinimizeBtn" class="button secondary-buttons">Minimize</button>
                <button id="alertModalDismissAllBtn" class="button secondary-buttons">Dismiss All</button>
            </div>
        </div>
    </div>
    <div id="shareContextMenu" class="context-menu">
        <button id="contextEditShareBtn" class="context-menu-item"><i class="fas fa-edit"></i> Edit Share</button>
        <button id="contextDeleteShareBtn" class="context-menu-item danger-button"><i class="fas fa-trash-alt"></i> Delete Share</button>
    </div>

    <div id="cashAssetFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <h2 id="cashFormTitle">Add New Cash Asset</h2>
                <div class="modal-header-action-group">
                    <span id="deleteCashAssetBtn" class="modal-action-icon danger hidden" title="Delete"><i class="fas fa-trash-alt"></i></span>
                    <span id="saveCashAssetBtn" class="modal-action-icon" title="Save Cash Asset"><i class="fas fa-save"></i></span>
                    <span class="close-button cash-form-close-button">&times;</span>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <label for="cashAssetName">Asset Name:</label>
                <input type="text" id="cashAssetName" placeholder="e.g., Savings Account" required>

                <label for="cashAssetBalance">Balance ($):</label>
                <input type="number" id="cashAssetBalance" step="0.01" placeholder="e.g., 10000.00" required>
                
                <div class="comments-form-container">
                    <h3>Comments <span id="addCashAssetCommentBtn" class="add-section-icon"><i class="fas fa-plus"></i></span></h3>
                    
                    <div id="cashAssetCommentsArea">
                        </div>
                </div>

                <div class="form-check-group">
                    <input type="checkbox" id="hideCashAssetCheckbox">
                    <label for="hideCashAssetCheckbox">Temporarily hide this asset and exclude from total</label>
                </div>
            </div>
        </div>
    </div>

<div id="stockSearchModal" class="modal">
        <div class="modal-content stock-search-modal-content">
            <div class="modal-header-with-icon">
                <h2 id="stockSearchTitle">Search ASX Stocks</h2>
                <div class="modal-header-action-group">
                    <span class="close-button search-close-button">&times;</span>
                </div>
            </div>
            
            <div class="modal-body-scrollable">
                <div class="search-input-container">
                    <input type="text" id="asxSearchInput" placeholder="Search by Code (e.g., BHP)" autocomplete="off">
                    <div id="asxSuggestions" class="autocomplete-suggestions">
                        </div>
                </div>

                <div id="searchResultDisplay" class="search-result-display">
                    <p class="initial-message">Start typing an ASX code to search.</p>
                </div>
            </div>

            <div class="modal-action-buttons-footer">
                </div>
        </div>
    </div>
    <div id="cashAssetDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header-with-icon">
                <h2 id="modalCashAssetName">Asset Details</h2>
                <div class="modal-header-action-group">
                    <span id="deleteCashAssetFromDetailBtn" class="modal-action-icon danger" title="Delete Cash Asset"><i class="fas fa-trash-alt"></i></span>
                    <span id="editCashAssetFromDetailBtn" class="modal-action-icon" title="Edit Cash Asset"><i class="fas fa-edit"></i></span>
                    <span class="close-button">&times;</span>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <p><strong>Asset Name:</strong> <span id="detailCashAssetName"></span></p>
                <p><strong>Balance:</strong> <span id="detailCashAssetBalance"></span></p>
                <p><strong>Last Updated:</strong> <span id="detailCashAssetLastUpdated"></span></p>
                <div id="modalCashAssetCommentsContainer" class="modal-comments-sections">
                    <h3>Comments</h3>
                    </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, FieldValue, deleteField, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // YOUR FIREBASE CONFIGURATION - Replace with your actual Firebase project config
        const firebaseConfig = {
            apiKey: "AIzaSyAyIWoTYlzTkaSZ9x-ySiHtzATBM9XFrYw", // Replace with your apiKey
            authDomain: "asx-watchlist-app.firebaseapp.com", // Replace with your authDomain
            projectId: "asx-watchlist-app", // Replace with your projectId
            storageBucket: "asx-watchlist-app.firebaseapp.com", // Replace with your storageBucket
            messagingSenderId: "671024168765", // Replace with your messagingSenderId
            appId: "1:671024168765:web:f2b62cd0e77a126c0ecf54", // Replace with your appId
            measurementId: "G-J24BTJ34D2" // Replace with your measurementId
        };

        const currentAppId = firebaseConfig.projectId || 'default-app-id';

        let firebaseApp;
        let auth;
        let db;
        let firebaseInitialized = false;

        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
            try {
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                firebaseInitialized = true;
                console.log("Firebase: Initialized successfully with config.");
            } catch (error) {
                console.error("Firebase: Failed to initialize app with provided config:", error);
                firebaseInitialized = false;
            }
        } else {
            console.error("Firebase: Configuration is missing or invalid (apiKey or projectId). Firebase will not initialize.");
            const errorDiv = document.getElementById('firebaseInitError');
            if (errorDiv) {
                errorDiv.style.display = 'block';
            }
            firebaseInitialized = false;
        }

        // Expose Firebase objects globally for script.js
        window.firestoreDb = firebaseInitialized ? db : null;
        window.firebaseAuth = firebaseInitialized ? auth : null;
        window.getFirebaseAppId = () => currentAppId;
        window.firestore = firebaseInitialized ? {
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            setDoc: setDoc,
            updateDoc: updateDoc,
            deleteDoc: deleteDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            getDocs: getDocs,
            deleteField: FieldValue.delete,
            writeBatch: writeBatch
        } : null;
        
        window.authFunctions = firebaseInitialized ? {
            GoogleAuthProviderInstance: new GoogleAuthProvider(),
            signInAnonymously: signInAnonymously,
            signInWithCustomToken: signInWithCustomToken,
            signInWithPopup: signInWithPopup,
            signInWithRedirect: signInWithRedirect,
            getRedirectResult: getRedirectResult,
            signOut: signOut,
            onAuthStateChanged: onAuthStateChanged
        } : null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log("index.html script module loaded and DOMContentLoaded fired.");
        }); 
    </script>
    <script src="script.js" type="module"></script>
</body>
<!-- Copilot update: 2025-07-29 - change for sync test -->
</html>