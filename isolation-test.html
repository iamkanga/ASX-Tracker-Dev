<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>Inline Share Form Isolation Test</title>
<style>
    :root {
        --bg: #0f1115;
        --panel: #1d2229;
        --panel-alt: #252c35;
        --accent: #a49393;
        --accent-hover: #bba8a8;
        --text: #f5f6f8;
        --ghost: #6c737d;
        --danger: #ff4d4d;
        --radius: 14px;
        --transition: 140ms ease;
        font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: inherit; background: linear-gradient(135deg,#101318,#171d24); color: var(--text); -webkit-font-smoothing:antialiased; }
    h1,h2,h3 { font-weight:600; letter-spacing:.5px; }
    p { line-height:1.45; }
    a { color: var(--accent); }

    header { padding: 28px clamp(16px,4vw,48px) 12px; }
    header h1 { margin:0 0 4px; font-size: clamp(1.6rem,3.4vw,2.35rem); background:linear-gradient(90deg,#d7d2d2,#a49393 70%); -webkit-background-clip:text; background-clip:text; color:transparent; }
    header .subtitle { color:var(--ghost); margin:0; font-size:0.95rem; }

    main { max-width: 1080px; margin:0 auto; padding:0 clamp(16px,4vw,48px) 120px; }
    .intro-block { max-width:760px; font-size:1.05rem; margin-bottom:40px; }
    .filler { margin:36px 0; background:linear-gradient(90deg,#1c2229,#202830); border:1px solid #2a323c; padding:20px 22px; border-radius:18px; box-shadow:0 4px 28px -8px #000 inset, 0 6px 18px -12px rgba(0,0,0,.6); }

    .actions-row { display:flex; gap:14px; flex-wrap:wrap; margin: 14px 0 34px; }
    button { cursor:pointer; font:inherit; background:var(--accent); color:#0d0f12; border:1px solid var(--accent); border-radius: 1000px; padding:12px 24px; font-weight:600; letter-spacing:.4px; transition: background var(--transition), transform var(--transition), box-shadow var(--transition); position:relative; overflow:hidden; }
    button:hover { background: var(--accent-hover); }
    button:active { transform:translateY(1px); }

    /* Inline Form Container */
    #shareFormWrapper { margin:0 auto; max-width:880px; }
    #shareFormSection { display:none; margin:0 0 80px; }
    #shareFormSection.inline-active { display:block; animation: fadeSlide .42s cubic-bezier(.21,.9,.24,1); }
    @keyframes fadeSlide { from { opacity:0; transform:translateY(24px) scale(.985); } to { opacity:1; transform:translateY(0) scale(1); } }

    .share-form-panel { background:linear-gradient(145deg,#232b33,#1d242b); border:1px solid #2b333c; border-radius: var(--radius); padding: 22px clamp(18px,2.6vw,38px) 46px; box-shadow:0 6px 48px -18px rgba(0,0,0,.65), 0 2px 6px -2px rgba(0,0,0,.5), 0 0 0 1px #303a44 inset; position:relative; overflow:hidden; }
    .form-header-bar { display:flex; align-items:flex-start; gap:18px; margin:0 0 18px; }
    .form-header-bar .titles { flex:1 1 auto; }
    .form-header-bar h2 { margin:.2rem 0 .15rem; font-size:1.6rem; letter-spacing:.75px; font-weight:700; }
    .form-header-bar p.company { margin:.1rem 0 0; font-size:.85rem; letter-spacing:.35px; font-weight:400; color:var(--ghost); text-transform:uppercase; }

    /* Action group - scrolls with page (NO sticky) */
    .form-actions { display:flex; flex-direction:row; gap:8px; }
    .icon-btn { width:44px; height:44px; border-radius:14px; background:linear-gradient(135deg,#2c3540,#222a32); border:1px solid #343f47; display:inline-flex; align-items:center; justify-content:center; color:var(--accent); font-size:1.05rem; position:relative; isolation:isolate; box-shadow:0 3px 14px -4px #000; }
    .icon-btn:hover { border-color:#46515a; color:#fff; }
    .icon-btn.danger { color:var(--danger); border-color:#3a1010; background:linear-gradient(135deg,#431e1e,#241212); }
    .icon-btn.danger:hover { border-color:#5c2020; color:#fff; }

    /* Accordion */
    .accordion { margin: 12px 0 4px; border-radius: 16px; overflow:hidden; border:1px solid #303942; background:linear-gradient(145deg,#1b2127,#232c36); }
    .accordion-section + .accordion-section { border-top:1px solid #303942; }
    .accordion-toggle { all:unset; cursor:pointer; display:flex; align-items:center; justify-content:space-between; width:100%; padding:16px 20px; font-weight:600; letter-spacing:.55px; font-size:.92rem; color:var(--accent); background:linear-gradient(90deg,#222a33,#1d242b); position:relative; }
    .accordion-toggle:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }
    .accordion-toggle .caret { transition: transform .3s ease; transform:rotate(-90deg); opacity:.9; }
    .accordion-section.open .accordion-toggle .caret { transform:rotate(0deg); }
    .accordion-panel { display:none; padding: 2px clamp(18px,2.4vw,32px) 26px; animation: panelFade .35s ease; }
    @keyframes panelFade { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:translateY(0); } }
    .accordion-section.open .accordion-panel { display:block; }

    label { display:block; font-size:.75rem; text-transform:uppercase; letter-spacing:.4px; margin:18px 0 6px; color:var(--ghost); font-weight:600; }
    input[type=text], input[type=number] { width:100%; background:#14191e; border:1px solid #2d363f; border-radius:12px; padding:12px 14px; font:600 0.95rem/1.2 'Inter', system-ui; color:var(--text); letter-spacing:.5px; box-shadow:0 1px 0 0 #000 inset, 0 0 0 1px #202930 inset; transition:border .18s; }
    input:focus { outline:none; border-color:var(--accent); }
    .input-row-inline { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:18px 22px; }

    .footer-info { margin-top:38px; font-size:.7rem; color:#46525d; letter-spacing:.45px; text-align:center; }

    /* Scroll Jump Diagnostics Bar */
    #diagBar { position:fixed; left:0; bottom:0; right:0; background:#14181d; border-top:1px solid #25303a; padding:6px 14px; font:500 12px/1.35 'Inter',sans-serif; letter-spacing:.5px; display:flex; flex-wrap:wrap; gap:16px; z-index:999; color:#9aa7b3; }
    #diagBar span { white-space:nowrap; }
    #diagBar .ok { color:#40d07d; }
    #diagBar .warn { color:#e2b04f; }
    #diagBar .bad { color:#ff6262; }

    /* Utility spacing for enough scroll area to expose any jump */
    .spacer-block { height:480px; background:linear-gradient(180deg,#12161b,#171d23); border:1px dashed #232c36; margin:34px 0 48px; border-radius:16px; display:flex; align-items:center; justify-content:center; color:#37424c; font-size:.85rem; letter-spacing:1px; }

    @media (max-width:760px){
        .share-form-panel { padding: 20px 18px 44px; }
        .form-header-bar h2 { font-size:1.35rem; }
        .accordion-panel { padding-left:18px; padding-right:18px; }
    }
</style>
</head>
<body>
<header>
    <h1>Inline Share Form Isolation</h1>
    <p class="subtitle">Goal: Prove a zero-scroll-jump inline opening & focus experience (no sticky header)</p>
</header>
<main>
    <section class="intro-block">
        <p>This standalone page isolates the problem. Click <strong>Open Form</strong> below. The form will be inserted inline (not modal), without a sticky header. We instrument scroll positions and detect any unintended jump or anchoring shift both on open and when focusing inputs. If a jump were to occur, it would be reported in the diagnostics bar at the bottom.</p>
        <p>The environment deliberately includes tall spacer regions & a heavy shadow form container to surface any scroll anchoring misbehavior. All code is self-contained & no external assets are loaded.</p>
    </section>
    <div class="actions-row">
        <button id="openFormBtn" type="button">Open Form</button>
        <button id="focusFirstInputBtn" type="button" disabled>Focus Code Input</button>
        <button id="collapseFormBtn" type="button" disabled>Collapse Form</button>
    </div>

    <div class="spacer-block">TOP SPACER – scroll down a little before opening to validate no jump</div>

    <div id="shareFormWrapper"></div>

    <div class="spacer-block">BOTTOM SPACER – provides lower scroll extents for further focus tests</div>

</main>

<div id="diagBar" aria-live="polite">
    <span id="diagOpen">Open: <span class="ok">pending</span></span>
    <span id="diagFocus">Focus: <span class="ok">pending</span></span>
    <span id="diagScroll">ScrollΔ: 0px</span>
    <span id="diagExtended" style="flex-basis:100%;font-weight:500;opacity:.9;">&nbsp;</span>
</div>

<script>
(function(){
    const state = {
        opened:false,
        baselineScroll:0,
        lastScroll:0,
        lastFocusScroll:0,
        openDelta:0,
        focusDelta:0,
        metrics: {
            open: { before:null, after:null, deltas:null },
            focus: { before:null, after:null, deltas:null }
        }
    };

    const openBtn = document.getElementById('openFormBtn');
    const focusBtn = document.getElementById('focusFirstInputBtn');
    const collapseBtn = document.getElementById('collapseFormBtn');
    const wrapper = document.getElementById('shareFormWrapper');

    const diagOpen = document.getElementById('diagOpen').querySelector('span');
    const diagFocus = document.getElementById('diagFocus').querySelector('span');
    const diagScroll = document.getElementById('diagScroll');

    function fmtDelta(d){ return (d>0?'+':'') + d + 'px'; }
    function classify(d){ if (Math.abs(d) < 2) return 'ok'; if (Math.abs(d) < 12) return 'warn'; return 'bad'; }

    function updateScrollDiag(){
        const cur = window.scrollY || document.documentElement.scrollTop;
        const delta = cur - state.lastScroll;
        state.lastScroll = cur;
        diagScroll.textContent = 'ScrollΔ: ' + fmtDelta(delta);
    }
    window.addEventListener('scroll', updateScrollDiag, { passive:true });

    function buildForm(){
        const container = document.createElement('section');
        container.id = 'shareFormSection';
        container.className = 'inline-active';
        container.innerHTML = `
            <div class="share-form-panel" role="form" aria-labelledby="formTitle">
                <div class="form-header-bar">
                    <div class="titles">
                        <h2 id="formTitle">Add New Share</h2>
                        <p class="company" id="companyName">Company (auto)</p>
                    </div>
                    <div class="form-actions" aria-label="Actions">
                        <button type="button" class="icon-btn danger" id="deleteBtn" title="Delete" aria-label="Delete">✕</button>
                        <button type="button" class="icon-btn" id="saveBtn" title="Save" aria-label="Save">💾</button>
                        <button type="button" class="icon-btn" id="closeBtn" title="Close" aria-label="Close">⤫</button>
                    </div>
                </div>
                <div class="accordion" id="shareFormAccordion">
                    ${buildAccordionSection('core','Core Info', `
                        <label for="shareCode">ASX Code</label>
                        <input id="shareCode" type="text" placeholder="BHP" autocomplete="off" />
                        <div class="input-row-inline">
                            <div>
                                <label for="watchlist">Watchlist</label>
                                <input id="watchlist" type="text" placeholder="Growth"/>
                            </div>
                            <div>
                                <label for="rating">Rating (1-5)</label>
                                <input id="rating" type="number" min="0" max="5" step="1" placeholder="3" />
                            </div>
                        </div>
                    `, true)}
                    ${buildAccordionSection('portfolio','Holdings', `
                        <label for="shares">Number of Shares</label>
                        <input id="shares" type="number" min="0" step="1" placeholder="1000" />
                        <label for="avgPrice">Average Purchase Price ($)</label>
                        <input id="avgPrice" type="number" min="0" step="0.01" placeholder="23.45" />
                    `)}
                    ${buildAccordionSection('target','Target & Rating', `
                        <label for="targetPrice">Target Price ($)</label>
                        <input id="targetPrice" type="number" step="0.01" placeholder="25.50" />
                        <label for="intent">Intent</label>
                        <input id="intent" type="text" placeholder="Buy / Sell" />
                    `)}
                    ${buildAccordionSection('dividends','Dividends', `
                        <label for="divAmount">Dividend Amount (annual $)</label>
                        <input id="divAmount" type="number" step="0.001" placeholder="1.250" />
                        <label for="frank">Franking Credits (%)</label>
                        <input id="frank" type="number" step="0.1" min="0" max="100" placeholder="70" />
                    `)}
                    ${buildAccordionSection('comments','Comments', `
                        <label for="comment1">Comment</label>
                        <input id="comment1" type="text" placeholder="Observation" />
                        <label for="comment2">Additional</label>
                        <input id="comment2" type="text" placeholder="Strategy notes" />
                    `)}
                </div>
                <div class="footer-info">Scroll & focus inputs: any unexpected scroll anchoring will be detected below.</div>
            </div>`;
        return container;
    }

    function buildAccordionSection(key,title,inner,open=false){
        return `<div class="accordion-section ${open?'open':''}" data-section="${key}">
            <button type="button" class="accordion-toggle" aria-expanded="${open}" aria-controls="panel-${key}" id="accordion-header-${key}">
                <span>${title}</span>
                <span class="caret">▶</span>
            </button>
            <div id="panel-${key}" class="accordion-panel" role="region" aria-labelledby="accordion-header-${key}">
                ${inner}
            </div>
        </div>`;
    }

    function initAccordion(root){
        root.addEventListener('click', e => {
            const header = e.target.closest('.accordion-toggle');
            if (!header) return;
            const section = header.closest('.accordion-section');
            if (!section) return;
            const open = section.classList.toggle('open');
            header.setAttribute('aria-expanded', open);
        });
    }

    function captureViewportMetrics(anchorBeforeTop){
        const vv = window.visualViewport || null;
        const scrollY = window.scrollY || document.documentElement.scrollTop;
        const anchorTop = (typeof anchorBeforeTop === 'number') ? anchorBeforeTop : (wrapper.getBoundingClientRect().top + scrollY);
        let form = document.getElementById('shareFormSection');
        const formTopDoc = form ? (form.getBoundingClientRect().top + scrollY) : null;
        return {
            ts: performance.now(),
            scrollY,
            vvOffsetTop: vv ? vv.offsetTop : null,
            vvPageTop: vv ? (vv.pageTop !== undefined ? vv.pageTop : null) : null,
            vvHeight: vv ? vv.height : null,
            anchorTopDoc: anchorTop,
            formTopDoc
        };
    }

    function computeDeltas(before, after){
        if (!before || !after) return null;
        function d(k){
            if (before[k] == null || after[k] == null) return null;
            return +(after[k] - before[k]).toFixed(2);
        }
        return {
            scrollY: d('scrollY'),
            vvOffsetTop: d('vvOffsetTop'),
            vvPageTop: d('vvPageTop'),
            vvHeight: d('vvHeight'),
            anchorTopDoc: d('anchorTopDoc'), // anchor shift
            formTopDoc: (before.formTopDoc==null || after.formTopDoc==null) ? null : +(after.formTopDoc - before.anchorTopDoc).toFixed(2) // movement vs original anchor
        };
    }

    function formatDeltas(d){
        if(!d) return '—';
        function seg(label, val){
            if (val === null || val === undefined) return `${label}: n/a`;
            const sign = val>0?'+':'';
            return `${label}: ${sign}${val}`;
        }
        return [
            seg('ScrollΔ', d.scrollY),
            seg('VV.topΔ', d.vvOffsetTop),
            seg('VV.pageTopΔ', d.vvPageTop),
            seg('VV.hΔ', d.vvHeight),
            seg('AnchorΔ', d.anchorTopDoc),
            seg('FormTopΔ', d.formTopDoc)
        ].join(' | ');
    }

    function openForm(){
        if (state.opened) return;
        state.baselineScroll = window.scrollY || document.documentElement.scrollTop;
        // Capture BEFORE metrics (no form yet) using anchor wrapper position
        const anchorBeforeTop = wrapper.getBoundingClientRect().top + state.baselineScroll;
        state.metrics.open.before = captureViewportMetrics(anchorBeforeTop);
        const node = buildForm();
        wrapper.appendChild(node);
        initAccordion(node.querySelector('#shareFormAccordion'));
        state.opened = true;
        requestAnimationFrame(()=>{
            const afterImmediate = window.scrollY || document.documentElement.scrollTop;
            const delta = afterImmediate - state.baselineScroll;
            state.openDelta = delta;
            const cls = classify(delta);
            diagOpen.className = cls;
            diagOpen.textContent = (cls==='ok'?'OK ':'Δ ') + fmtDelta(delta);
            focusBtn.disabled = false;
            collapseBtn.disabled = false;
            console.log('[Isolation][Open] Immediate scroll delta:', delta);
            // Defer AFTER metrics to allow layout/paint/UA adjustments (500ms window)
            setTimeout(()=>{
                state.metrics.open.after = captureViewportMetrics(anchorBeforeTop);
                state.metrics.open.deltas = computeDeltas(state.metrics.open.before, state.metrics.open.after);
                const diagExtended = document.getElementById('diagExtended');
                const summary = formatDeltas(state.metrics.open.deltas);
                if (diagExtended) diagExtended.textContent = summary;
                console.log('[Isolation][Open] BEFORE metrics:', state.metrics.open.before);
                console.log('[Isolation][Open] AFTER metrics:', state.metrics.open.after);
                console.log('[Isolation][Open] DELTAS:', state.metrics.open.deltas);
            }, 500);
        });
    }

    function collapseForm(){
        if (!state.opened) return;
        const form = document.getElementById('shareFormSection');
        if (form) form.remove();
        state.opened = false;
        focusBtn.disabled = true;
        collapseBtn.disabled = true;
        console.log('[Isolation] Form collapsed');
    }

    function focusFirst(){
        const field = document.getElementById('shareCode');
        if (!field) return;
        const beforeScroll = window.scrollY || document.documentElement.scrollTop;
        const beforeMetrics = captureViewportMetrics();
        state.metrics.focus.before = beforeMetrics;
        field.focus({ preventScroll:true });
        setTimeout(()=>{
            const afterScroll = window.scrollY || document.documentElement.scrollTop;
            const delta = afterScroll - beforeScroll;
            state.focusDelta = delta;
            const cls = classify(delta);
            diagFocus.className = cls;
            diagFocus.textContent = (cls==='ok'?'OK ':'Δ ') + fmtDelta(delta);
            state.metrics.focus.after = captureViewportMetrics(beforeMetrics.anchorTopDoc);
            state.metrics.focus.deltas = computeDeltas(state.metrics.focus.before, state.metrics.focus.after);
            console.log('[Isolation][Focus] Scroll delta:', delta);
            console.log('[Isolation][Focus] BEFORE metrics:', state.metrics.focus.before);
            console.log('[Isolation][Focus] AFTER metrics:', state.metrics.focus.after);
            console.log('[Isolation][Focus] DELTAS:', state.metrics.focus.deltas);
        }, 220); // longer to allow virtual keyboard adjustments
    }

    openBtn.addEventListener('click', openForm);
    focusBtn.addEventListener('click', focusFirst);
    collapseBtn.addEventListener('click', collapseForm);

})();
</script>
</body>
</html>